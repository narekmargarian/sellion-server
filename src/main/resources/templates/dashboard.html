<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sellion ERP 2026</title>
    <!-- Иконки Bootstrap -->
    <link rel="stylesheet" href="cdn.jsdelivr.net">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<div class="sidebar">
    <div class="brand">SELLION 2026</div>
    <div onclick="showTab('tab-orders')" class="nav-link" id="btn-orders"><i class="bi bi-cart"></i> Заказы</div>
    <div onclick="showTab('tab-returns')" class="nav-link" id="btn-returns"><i class="bi bi-arrow-counterclockwise"></i> Возвраты</div>
    <div onclick="showTab('tab-clients')" class="nav-link" id="btn-clients"><i class="bi bi-people"></i> Клиенты</div>
    <div onclick="showTab('tab-products')" class="nav-link" id="btn-products"><i class="bi bi-box-seam"></i> Склад / Цены</div>

    <form th:action="@{/logout}" method="post" style="margin-top:auto; padding:20px;">
        <button type="submit" style="width:100%; background:#ef4444; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:700;">ВЫХОД</button>
    </form>
</div>

<div class="main">
    <div class="scroll-area">

        <!-- ВКЛАДКА ЗАКАЗЫ -->
        <div id="tab-orders" class="tab-pane">
            <div class="summary-card">
                <div class="summary-item"><small>Заказов всего:</small> <span th:text="${totalOrdersCount}">0</span></div>
                <div class="summary-item"><small>Общая сумма:</small> <span class="price-up" th:text="${#numbers.formatInteger(totalOrdersSum, 1, 'WHITESPACE') + ' ֏'}">0</span></div>
            </div>
            <div style="margin-bottom: 20px; display:flex; gap:15px;">
                <form method="get" th:action="@{/admin}">
                    <input type="hidden" name="activeTab" value="tab-orders">
                    <select name="orderManagerId" onchange="this.form.submit()" style="padding:8px; border-radius:8px; border:1px solid #ddd;">
                        <option value="">Все менеджеры (Заказы)</option>
                        <option th:each="m : ${managers}" th:value="${m}" th:text="${m}" th:selected="${m == selectedOrderManager}"></option>
                    </select>
                </form>
                <button class="btn-primary" onclick="alert('Создание заказа...')">+ Создать заказ</button>
            </div>
            <div class="card">
                <table class="table">
                    <thead><tr><th>Дата</th><th>Менеджер</th><th>Магазин</th><th>Сумма</th><th>Статус</th><th>Действие</th></tr></thead>
                    <tbody>
                    <tr th:each="o : ${orders}" th:onclick="'openOrderDetails(' + ${o.id} + ')'" style="cursor:pointer;">
                        <td th:text="${#temporals.format(o.createdAt, 'dd.MM.yyyy HH:mm')}"></td>
                        <td th:text="${o.managerId}" style="font-weight:600; color:var(--accent);"></td>
                        <td th:text="${o.shopName}" style="font-weight:700;"></td>
                        <td class="price-up" th:text="${o.totalAmount + ' ֏'}"></td>
                        <td><span class="badge" th:text="${o.status}"></span></td>
                        <td onclick="event.stopPropagation()">
                            <form th:if="${o.invoiceId == null}" th:action="@{'/admin/invoices/create-from-order/' + ${o.id}}" method="post">
                                <button type="submit" class="btn-primary" style="padding:5px 10px; font-size:11px;">Счет</button>
                            </form>
                            <span th:if="${o.invoiceId != null}"><i class="bi bi-lock-fill" style="color:#cbd5e1"></i></span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ВКЛАДКА ВОЗВРАТЫ -->
        <div id="tab-returns" class="tab-pane">
            <div class="summary-card" style="background: #fff1f2; border-color: #fecdd3;">
                <div class="summary-item"><small>Возвратов всего:</small> <span th:text="${totalReturnsCount}">0</span></div>
                <div class="summary-item"><small>Сумма возвратов:</small> <span class="price-down" th:text="${#numbers.formatInteger(totalReturnsSum, 1, 'WHITESPACE') + ' ֏'}">0</span></div>
            </div>
            <div style="margin-bottom: 20px;">
                <form method="get" th:action="@{/admin}">
                    <input type="hidden" name="activeTab" value="tab-returns">
                    <select name="returnManagerId" onchange="this.form.submit()" style="padding:8px; border-radius:8px; border:1px solid #ddd;">
                        <option value="">Все менеджеры (Возвраты)</option>
                        <option th:each="m : ${managers}" th:value="${m}" th:text="${m}" th:selected="${m == selectedReturnManager}"></option>
                    </select>
                </form>
            </div>
            <div class="card">
                <table class="table">
                    <thead><tr><th>Дата</th><th>Менеджер</th><th>Магазин</th><th>Причина</th><th>Сумма</th></tr></thead>
                    <tbody>
                    <tr th:each="r : ${returns}" th:onclick="'openReturnDetails(' + ${r.id} + ')'" style="cursor:pointer;">
                        <td th:text="${r.returnDate}"></td>
                        <td th:text="${r.managerId}" style="font-weight:600; color:var(--accent);"></td>
                        <td th:text="${r.shopName}" style="font-weight:700;"></td>
                        <td th:text="${r.returnReason}"></td>
                        <td class="price-down" th:text="${r.totalAmount + ' ֏'}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ВКЛАДКА КЛИЕНТЫ -->
        <div id="tab-clients" class="tab-pane">
            <button class="btn-primary" style="margin-bottom:20px;" onclick="openModal('modal-client')">+ Добавить клиента</button>
            <div class="card">
                <table class="table">
                    <thead><tr><th>Магазин</th><th>Адрес</th><th>Долг</th></tr></thead>
                    <tbody>
                    <tr th:each="c : ${clients}"><td th:text="${c.name}"></td><td th:text="${c.address}"></td><td class="price-down" th:text="${c.debt + ' ֏'}"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ВКЛАДКА СКЛАД -->
        <div id="tab-products" class="tab-pane">
            <div class="card">
                <table class="table">
                    <thead><tr><th>Товар</th><th>Цена</th><th>Остаток</th><th>Упак.</th><th>Штрих-код</th><th>Действие</th></tr></thead>
                    <tbody>
                    <tr th:each="p : ${products}">
                        <td th:text="${p.name}" style="font-weight:600"></td>
                        <td th:text="${p.price + ' ֏'}"></td>
                        <td th:text="${p.stockQuantity + ' шт.'}"></td>
                        <td th:text="${p.itemsPerBox}"></td>
                        <td th:text="${p.barcode}"></td>
                        <td><button class="btn-primary" style="padding:5px 10px;" th:onclick="'editProduct(' + ${p.id} + ')'">Изменить</button></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- МОДАЛЬНЫЕ ОКНА -->

<!-- 1. ПРОСМОТР -->
<div id="modal-order-view" class="modal">
    <div class="modal-content" style="width: 850px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="modal-title" style="margin: 0;">Детали операции</h2>
            <button onclick="closeModal('modal-order-view')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div id="order-info" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 10px;"></div>

        <table class="table">
            <thead>
            <tr><th>Продукт</th><th>Кол-во</th><th>Прайс</th><th>Итог</th><th>Категория</th></tr>
            </thead>
            <tbody id="order-items-body"></tbody>
        </table>

        <div style="text-align: right; margin-top: 20px; font-size: 18px; font-weight: 700;" id="order-total-price"></div>
        <div id="order-footer-actions" style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;"></div>
    </div>
</div>

<!-- 2. ИЗМЕНЕНИЕ ЗАКАЗА -->
<div id="modal-order-edit" class="modal">
    <div class="modal-content">
        <h3>Редактирование состава</h3>
        <input type="hidden" id="edit-order-id">
        <div id="edit-items-list" style="margin-bottom:20px; max-height: 400px; overflow-y: auto;"></div>
        <div style="display:flex; gap:10px;">
            <button class="btn-primary" onclick="saveOrderChanges()" style="flex:1">Сохранить</button>
            <button class="btn-primary" style="background:#64748b; flex:1;" onclick="closeModal('modal-order-edit')">Отмена</button>
        </div>
    </div>
</div>

<!-- 3. НОВЫЙ КЛИЕНТ -->
<div id="modal-client" class="modal">
    <div class="modal-content">
        <h3>Новый магазин</h3>
        <form th:action="@{/admin/clients/create}" method="post">
            <input type="text" name="name" placeholder="Название магазина" required style="width:100%; padding:11px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd; box-sizing:border-box;">
            <input type="text" name="address" placeholder="Адрес" style="width:100%; padding:11px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd; box-sizing:border-box;">
            <input type="text" name="phone" placeholder="Телефон" style="width:100%; padding:11px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd; box-sizing:border-box;">
            <div style="display:flex; gap:10px;">
                <button type="submit" class="btn-primary" style="flex:1">Сохранить</button>
                <button type="button" onclick="closeModal('modal-client')" style="flex:1; background:#eee; color:#333; border:none; padding:10px; border-radius:8px; cursor:pointer;">Отмена</button>
            </div>
        </form>
    </div>
</div>

<!-- 4. ИЗМЕНЕНИЕ ТОВАРА -->
<div id="modal-product-edit" class="modal">
    <div class="modal-content">
        <h3>Редактирование товара</h3>
        <input type="hidden" id="edit-product-id">
        <div style="display:grid; gap:10px;">
            <div><small>Название</small><br><input type="text" id="edit-product-name" style="width:100%; padding:8px;"></div>
            <div><small>Цена (֏)</small><br><input type="number" id="edit-product-price" style="width:100%; padding:8px;"></div>
            <div><small>Остаток (шт)</small><br><input type="number" id="edit-product-stock" style="width:100%; padding:8px;"></div>
            <div><small>В упаковке</small><br><input type="number" id="edit-product-box" style="width:100%; padding:8px;"></div>
            <div><small>Штрих-код</small><br><input type="text" id="edit-product-barcode" style="width:100%; padding:8px;"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-primary" onclick="saveProductChanges()" style="flex:1">Обновить</button>
            <button class="btn-primary" style="background:#64748b; flex:1;" onclick="closeModal('modal-product-edit')">Отмена</button>
        </div>
    </div>
</div>

<!-- ДАННЫЕ И СКРИПТ -->
<script th:inline="javascript">
    const ordersData = [[${orders}]];
    const returnsData = [[${returns}]];
    const productsData = [[${products}]];
</script>
<script th:src="@{/js/script.js}"></script>
</body>
</html>
