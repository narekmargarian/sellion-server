<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${title != null ? title : 'Реестр операций'}">Реестр операций</title>
    <style>
        body { font-family: 'Inter', sans-serif; font-size: 11px; margin: 0; color: #000; }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .main-table { width: 100%; border-collapse: collapse; }
        .main-table th, .main-table td { border: 1px solid #000; padding: 6px; text-align: left; }
        .main-table th { background: #f0f0f0 !important; text-transform: uppercase; -webkit-print-color-adjust: exact; }
        .total-row { font-weight: bold; background: #f9f9f9 !important; }
        .text-right { text-align: right; }
        .col-id { width: 40px; text-align: center; }

        @media print {
            @page { margin: 0; }
            body { margin: 1.5cm; }
        }
    </style>

</head>
<body>
<div th:if="${operations != null}">
    <div class="header">
        <h1 th:text="${title != null ? title : 'РЕЕСТР'}" style="margin: 0; font-size: 18px;">РЕЕСТР</h1>
        <p style="margin: 5px 0;">Дата печати: <span th:text="${currentDateTime != null ? #temporals.format(currentDateTime, 'dd.MM.yyyy HH:mm') : '---'}"></span></p>
    </div>

    <table class="main-table">
        <thead>
        <tr>
            <th class="col-id">№</th>
            <th style="width: 110px;">Дата</th>
            <th>Магазин</th>
            <th class="text-right" style="width: 100px;">Сумма (֏)</th>
            <th>Комментарий/Причина</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="op, stat : ${operations}" th:if="${op != null}">
            <td class="col-id" th:text="${stat.count}">1</td>

            <td th:text="${op.createdAt != null ? #temporals.format(op.createdAt, 'dd.MM.yyyy HH:mm') : '---'}"></td>

            <td th:text="${op.shopName != null ? op.shopName : '---'}" style="font-weight: bold;"></td>

            <!-- УМНАЯ СУММА ОПЕРАЦИИ -->
            <td class="text-right">
            <span th:with="val=${op.totalAmount != null ? op.totalAmount.doubleValue() : 0}"
                  th:text="${(val % 1 == 0) ? #numbers.formatInteger(val, 1, 'WHITESPACE') : #numbers.formatDecimal(val, 1, 'WHITESPACE', 2, 'POINT').replaceAll('0$', '')}">
            </span>
            </td>

            <td>
                <!-- Безопасная проверка через #strings -->
                <th:block th:if="${title != null && #strings.contains(title, 'ВОЗВРАТ')}">
                    <span th:text="${op.returnReason != null ? op.returnReason.displayName : '---'}"></span>
                </th:block>

                <th:block th:if="${title != null && #strings.contains(title, 'ЗАКАЗ')}">
                    <span th:text="${(op.comment != null && !op.comment.isEmpty()) ? op.comment : (op.paymentMethod != null ? op.paymentMethod.displayName : '---')}"></span>
                </th:block>
            </td>
        </tr>
        <tr th:if="${#lists.isEmpty(operations)}">
            <td colspan="5" style="text-align: center; padding: 20px;">Операций не найдено</td>
        </tr>
        </tbody>
        <tfoot>
        <tr class="total-row">
            <td colspan="3" class="text-right">ИТОГО ПО РЕЕСТРУ:</td>

            <!-- УМНОЕ ИТОГО ПО ВСЕМУ РЕЕСТРУ -->
            <td class="text-right">
            <span th:with="fVal=${finalTotal != null ? finalTotal.doubleValue() : 0}"
                  th:text="${(fVal % 1 == 0) ? #numbers.formatInteger(fVal, 1, 'WHITESPACE') : #numbers.formatDecimal(fVal, 1, 'WHITESPACE', 2, 'POINT').replaceAll('0$', '')} + ' ֏'">
            </span>
            </td>

            <td></td>
        </tr>
        </tfoot>

    </table>
</div>

<div th:if="${operations == null}" style="text-align: center; padding: 50px;">
    <h2>Данные реестра не сформированы</h2>
</div>

</body>
</html>
