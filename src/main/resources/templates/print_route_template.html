<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Inter', sans-serif; font-size: 12px; margin: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; vertical-align: top; }
        th { background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; }
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
        .summary { margin-top: 20px; font-weight: bold; text-align: right; font-size: 14px; border-top: 2px solid #000; padding-top: 5px; }

        @media print {
            @page { margin: 0; }
            body { margin: 1.5cm; }
        }
    </style>
</head>
<body>
<div th:if="${orders != null}">
    <div class="header">
        <h2 th:text="${title != null ? title : 'МАРШРУТНЫЙ ЛИСТ'}"></h2>
        <p>Менеджер: <b th:text="${managerId != null ? managerId : '---'}"></b> |
            Дата доставки: <span th:text="${date != null ? date : '---'}"></span> |
            Печать: <span th:text="${#temporals.format(#temporals.createNow(), 'HH:mm')}"></span></p>
    </div>
    <table>
        <thead>
        <tr>
            <th style="width: 30px;">№</th>
            <th>Магазин / Адрес</th>
            <th style="width: 100px;">Сумма</th>
            <th style="width: 90px;">Оплата</th>
            <th>Комментарий</th>
            <th style="width: 100px;">Подпись</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="o, stat : ${orders}" th:if="${o != null}">
            <td th:text="${stat.count}"></td>
            <td>
                <strong th:text="${o.shopName != null ? o.shopName : '---'}"></strong><br>
                <!-- БЕЗОПАСНОЕ ПОЛУЧЕНИЕ АДРЕСА -->
                <small th:with="clientOpt=${clientRepo.findByName(o.shopName)}"
                       th:text="${clientOpt != null && clientOpt.isPresent() ? clientOpt.get().address : 'Адрес не найден'}"></small>
            </td>
            <td th:text="${#numbers.formatDecimal((o.totalAmount ?: 0), 1, 'WHITESPACE', 0, 'POINT') + ' ֏'}"></td>

            <td th:text="${o.paymentMethod != null ? o.paymentMethod.displayName : '---'}"></td>
            <td th:text="${o.comment}"></td>
            <td></td>
        </tr>
        <tr th:if="${#lists.isEmpty(orders)}">
            <td colspan="6" style="text-align: center; padding: 20px;">Нет заказов на выбранную дату</td>
        </tr>
        </tbody>
    </table>
    <div class="summary">
        ИТОГО К СДАЧЕ:
        <span th:with="safeTotal=${routeTotal ?: 0}"
              th:text="${#numbers.formatDecimal(safeTotal, 1, 'WHITESPACE', 0, 'POINT') + ' ֏'}">
    </span>
    </div>


</div>

<div th:if="${orders == null}" style="text-align: center; padding: 50px;">
    <h2>Маршрут не сформирован</h2>
</div>
</body>
</html>
