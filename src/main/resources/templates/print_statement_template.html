<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Inter', sans-serif; font-size: 12px; padding: 0; margin: 0; }
        .header { text-align: center; margin-bottom: 30px; }
        .details { margin-bottom: 20px; border: 1px solid #000; padding: 10px; line-height: 1.6; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
        th { background: #f2f2f2 !important; -webkit-print-color-adjust: exact; }
        .sum-row { font-weight: bold; background: #fafafa !important; }
        .footer { margin-top: 50px; display: flex; justify-content: space-between; }
        .sign { border-top: 1px solid #000; width: 200px; text-align: center; padding-top: 5px; margin-top: 40px; }
        .text-right { text-align: right; }

        @media print {
            @page { margin: 0; }
            body { margin: 1.5cm; }
        }
    </style>
</head>
<body>
<div th:if="${client != null}">
    <div class="header">
        <h2>АКТ СВЕРКИ ВЗАИМОРАСЧЕТОВ</h2>
        <p>за период с <span th:text="${startDate != null ? startDate : '...'}"></span> по <span th:text="${endDate != null ? endDate : '...'}"></span></p>
    </div>

    <div class="details">
        <strong>Организация (Поставщик):</strong>
        <span th:text="${@companySettings != null ? @companySettings.getSetting('COMPANY_NAME', 'Sellion ERP') : 'Sellion ERP'}"></span><br>
        <strong>ИНН:</strong>
        <span th:text="${@companySettings != null ? @companySettings.getSetting('COMPANY_INN', '---') : '---'}"></span><br>
        <strong>Адрес:</strong>
        <span th:text="${@companySettings != null ? @companySettings.getSetting('COMPANY_ADDRESS', '---') : '---'}"></span><br>

        <hr style="border: 0; border-top: 1px solid #000; margin: 10px 0;">

        <strong>Контрагент:</strong> <span th:text="${client.name != null ? client.name : '---'}"></span><br>
        <strong>Адрес:</strong> <span th:text="${client.address != null ? client.address : '---'}"></span>
    </div>

    <table>
        <thead>
        <tr>
            <th>Дата</th>
            <th>Документ</th>
            <th class="text-right">Дебет (Заказ)</th>
            <th class="text-right">Кредит (Оплата)</th>
            <th class="text-right">Остаток</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="tx : ${transactions}" th:if="${tx != null}">
            <td th:text="${tx.timestamp != null ? #temporals.format(tx.timestamp, 'dd.MM.yyyy') : '---'}"></td>
            <td th:text="${tx.comment != null ? tx.comment : '---'}"></td>
            <!-- Безопасная проверка типа и форматирование -->
            <td class="text-right" th:text="${#strings.toString(tx.type) == 'ORDER' ? #numbers.formatDecimal(tx.amount, 1, 'WHITESPACE', 0, 'POINT') : ''}"></td>
            <td class="text-right" th:text="${#strings.toString(tx.type) != 'ORDER' ? #numbers.formatDecimal(tx.amount, 1, 'WHITESPACE', 0, 'POINT') : ''}"></td>
            <td class="text-right"
                style="font-weight: bold;"
                th:with="balance=${tx.balanceAfter ?: 0}"
                th:text="${#numbers.formatDecimal(balance, 1, 'WHITESPACE', 0, 'POINT') + ' ֏'}">
            </td>

        </tr>
        <tr th:if="${#lists.isEmpty(transactions)}">
            <td colspan="5" style="text-align: center; padding: 20px;">Записей за указанный период не найдено.</td>
        </tr>
        </tbody>
        <tfoot>
        <!-- Найти строку с итоговым сальдо и заменить на: -->
        <tr class="sum-row">
            <td colspan="4" class="text-right">ИТОГОВОЕ САЛЬДО:</td>
            <td class="text-right"
                th:with="cDebt=${client.debt ?: 0}"
                th:text="${#numbers.formatDecimal(cDebt, 1, 'WHITESPACE', 0, 'POINT') + ' ֏'}">
            </td>
        </tr>

        </tfoot>
    </table>

    <div class="footer">
        <div>
            От <span th:text="${@companySettings != null ? @companySettings.getSetting('COMPANY_NAME', 'Sellion ERP') : 'Sellion ERP'}"></span>:<br>
            <div class="sign">(Подпись, печать)</div>
        </div>
        <div>
            От <span th:text="${client.name}"></span>:<br>
            <div class="sign">(Подпись, печать)</div>
        </div>
    </div>
</div>

<div th:if="${client == null}" style="text-align: center; padding: 50px;">
    <h2>Ошибка: Клиент не выбран</h2>
</div>
</body>
</html>
