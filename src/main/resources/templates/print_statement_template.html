<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Inter', sans-serif; font-size: 12px; padding: 0; margin: 0; }
        .header { text-align: center; margin-bottom: 30px; }
        .details { margin-bottom: 20px; border: 1px solid #000; padding: 10px; line-height: 1.6; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
        th { background: #f2f2f2 !important; -webkit-print-color-adjust: exact; }
        .sum-row { font-weight: bold; background: #fafafa !important; }
        .footer { margin-top: 50px; display: flex; justify-content: space-between; }
        .sign { border-top: 1px solid #000; width: 200px; text-align: center; padding-top: 5px; margin-top: 40px; }
        .text-right { text-align: right; }

        @media print {
            @page { margin: 0; }
            body { margin: 1.5cm; }
        }
    </style>
</head>
<body>
<div th:if="${client != null}">
    <div class="header">
        <h2>АКТ СВЕРКИ ВЗАИМОРАСЧЕТОВ</h2>
        <p>за период с <span th:text="${startDate != null ? startDate : '...'}"></span> по <span th:text="${endDate != null ? endDate : '...'}"></span></p>
    </div>

    <div class="details">
        <strong>Организация (Поставщик):</strong>
        <span th:text="${@companySettings != null ? @companySettings.getSetting('COMPANY_NAME', 'Sellion ERP') : 'Sellion ERP'}"></span><br>
        <strong>ИНН:</strong>
        <span th:text="${@companySettings != null ? @companySettings.getSetting('COMPANY_INN', '---') : '---'}"></span><br>
        <strong>Адрес:</strong>
        <span th:text="${@companySettings != null ? @companySettings.getSetting('COMPANY_ADDRESS', '---') : '---'}"></span><br>

        <hr style="border: 0; border-top: 1px solid #000; margin: 10px 0;">

        <strong>Контрагент:</strong> <span th:text="${client.name != null ? client.name : '---'}"></span><br>
        <strong>Адрес:</strong> <span th:text="${client.address != null ? client.address : '---'}"></span>
    </div>

    <table>
        <thead>
        <tr>
            <th>Дата</th>
            <th>Документ</th>
            <th class="text-right">Дебет (Заказ)</th>
            <th class="text-right">Кредит (Оплата)</th>
            <th class="text-right">Остаток</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="tx : ${transactions}" th:if="${tx != null}">
            <td th:text="${tx.timestamp != null ? #temporals.format(tx.timestamp, 'dd.MM.yyyy') : '---'}"></td>
            <td th:text="${tx.comment != null ? tx.comment : '---'}"></td>

            <!-- ДЕБЕТ (ЗАКАЗ) -->
            <td class="text-right">
        <span th:if="${#strings.toString(tx.type) == 'ORDER'}"
              th:with="dVal=${tx.amount != null ? tx.amount.doubleValue() : 0}"
              th:text="${(dVal % 1 == 0) ? #numbers.formatInteger(dVal, 1, 'WHITESPACE') : #numbers.formatDecimal(dVal, 1, 'WHITESPACE', 2, 'POINT').replaceAll('0$', '')}">
        </span>
            </td>

            <!-- КРЕДИТ (ОПЛАТА/ВОЗВРАТ) -->
            <td class="text-right">
        <span th:if="${#strings.toString(tx.type) != 'ORDER'}"
              th:with="kVal=${tx.amount != null ? tx.amount.doubleValue() : 0}"
              th:text="${(kVal % 1 == 0) ? #numbers.formatInteger(kVal, 1, 'WHITESPACE') : #numbers.formatDecimal(kVal, 1, 'WHITESPACE', 2, 'POINT').replaceAll('0$', '')}">
        </span>
            </td>

            <!-- ТЕКУЩИЙ ОСТАТОК (БАЛАНС) -->
            <td class="text-right" style="font-weight: bold;">
        <span th:with="bVal=${tx.balanceAfter != null ? tx.balanceAfter.doubleValue() : 0}"
              th:text="${(bVal % 1 == 0) ? #numbers.formatInteger(bVal, 1, 'WHITESPACE') : #numbers.formatDecimal(bVal, 1, 'WHITESPACE', 2, 'POINT').replaceAll('0$', '')} + ' ֏'">
        </span>
            </td>
        </tr>
        <tr th:if="${#lists.isEmpty(transactions)}">
            <td colspan="5" style="text-align: center; padding: 20px;">Записей за указанный период не найдено.</td>
        </tr>
        </tbody>
        <tfoot>
        <tr class="sum-row">
            <td colspan="4" class="text-right">ИТОГОВОЕ САЛЬДО:</td>
            <td class="text-right">
                <!-- ИТОГОВОЕ САЛЬДО -->
                <span th:with="cDebtVal=${client.debt != null ? client.debt.doubleValue() : 0}"
                      th:text="${(cDebtVal % 1 == 0) ? #numbers.formatInteger(cDebtVal, 1, 'WHITESPACE') : #numbers.formatDecimal(cDebtVal, 1, 'WHITESPACE', 2, 'POINT').replaceAll('0$', '')} + ' ֏'">
        </span>
            </td>
        </tr>
        </tfoot>

    </table>

    <div class="footer">
        <div>
            От <span th:text="${@companySettings != null ? @companySettings.getSetting('COMPANY_NAME', 'Sellion ERP') : 'Sellion ERP'}"></span>:<br>
            <div class="sign">(Подпись, печать)</div>
        </div>
        <div>
            От <span th:text="${client.name}"></span>:<br>
            <div class="sign">(Подпись, печать)</div>
        </div>
    </div>
</div>

<div th:if="${client == null}" style="text-align: center; padding: 50px;">
    <h2>Ошибка: Клиент не выбран</h2>
</div>
</body>
</html>
