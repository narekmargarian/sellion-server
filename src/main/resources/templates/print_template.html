<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Inter', sans-serif; font-size: 11px; color: #333; margin: 0; }
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .company-info { line-height: 1.4; font-size: 11px; }
        .doc-title { font-size: 18px; font-weight: bold; text-transform: uppercase; }
        .info-table { width: 100%; margin-bottom: 15px; border-collapse: collapse; }
        .info-table td { padding: 4px 0; border-bottom: 1px solid #eee; }
        .main-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .main-table th { background: #f0f0f0 !important; border: 1px solid #ccc; padding: 6px; text-align: left; -webkit-print-color-adjust: exact; font-size: 10px; }
        .main-table td { border: 1px solid #ccc; padding: 6px; }
        .total-block { text-align: right; font-size: 15px; font-weight: bold; margin-top: 10px; }
        .footer-sig { margin-top: 40px; display: flex; justify-content: space-between; }
        .sig-line { border-top: 1px solid #000; width: 180px; margin-top: 35px; text-align: center; font-size: 9px; padding-top: 5px; }

        @media print {
            @page { margin: 0; }
            body { margin: 1cm; }
        }
    </style>
</head>
<body>

<div th:if="${op != null}"
     th:with="isOrder=${#strings.contains(op.class.name, 'Order') and !#strings.contains(op.class.name, 'Return')}">

    <div class="header">
        <div class="company-info">
            <strong th:text="${@companySettings != null ? @companySettings.getSetting('COMPANY_NAME', 'SELLION ERP 2026') : 'SELLION ERP 2026'}"></strong><br>
            <span th:text="${@companySettings != null ? @companySettings.getSetting('COMPANY_ADDRESS', 'г. Ереван, Армения') : 'г. Ереван, Армения'}"></span>
        </div>
        <div class="doc-title" th:text="${title != null ? title : (isOrder ? 'НАКЛАДНАЯ' : 'АКТ ВОЗВРАТА')}">ДОКУМЕНТ</div>
    </div>

    <table class="info-table">
        <tr>
            <td width="160">Контрагент (Магазин):</td>
            <td><strong th:text="${op.shopName != null ? op.shopName : '---'}"></strong></td>
        </tr>
        <tr>
            <td>Дата документа:</td>
            <td th:with="docDate=${isOrder ? op.deliveryDate : (op.class.name.contains('Return') ? op.returnDate : null)}"
                th:text="${docDate != null ? #temporals.format(docDate, 'dd.MM.yyyy') : (op.createdAt != null ? #temporals.format(op.createdAt, 'dd.MM.yyyy HH:mm') : '---')}">
            </td>
        </tr>
        <tr>
            <td>Ответственное лицо:</td>
            <td th:text="${op.managerId != null ? op.managerId : '---'}">Менеджер</td>
        </tr>
    </table>

    <table class="main-table">
        <thead>
        <tr>
            <th style="width: 30px;">№</th>
            <th>Наименование товара</th>
            <th style="width: 50px; text-align: center;">Кол-во</th>
            <!-- Скрываются для возвратов -->
            <th th:if="${isOrder}" style="width: 80px; text-align: right;">Прайс</th>
            <th th:if="${isOrder}" style="width: 40px; text-align: center;">%</th>
            <th style="width: 80px; text-align: right;">Цена (֏)</th>
            <th style="width: 100px; text-align: right;">Сумма (֏)</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="entry, stat : ${op.items}"
            th:with="
                pId=${entry.key},
                qty=${entry.value},
                p=${productRepo.findById(pId).orElse(null)},
                discount=${isOrder ? (op.appliedPromoItems != null ? (op.appliedPromoItems.getOrDefault(pId, (op.discountPercent != null ? op.discountPercent : 0))) : (op.discountPercent != null ? op.discountPercent : 0)) : 0},
                basePrice=${p != null ? p.price : 0},
                finalPrice=${isOrder ? (basePrice.doubleValue() * (1.0 - (discount.doubleValue() / 100.0))) : (op.itemPrices != null ? (op.itemPrices.getOrDefault(pId, basePrice)) : basePrice)},
                rowTotal=${finalPrice.doubleValue() * qty}">

            <td style="text-align: center;" th:text="${stat.count}"></td>
            <td th:text="${p != null ? p.name : 'Товар #' + pId}"></td>
            <td style="text-align: center;" th:text="${qty}"></td>

            <!-- Колонки ЗАКАЗА с вашим форматированием -->
            <th:block th:if="${isOrder}">
                <td style="text-align: right;"
                    th:text="${basePrice.doubleValue() % 1 == 0 ? #numbers.formatDecimal(basePrice, 1, 'WHITESPACE', 0, 'POINT') : #numbers.formatDecimal(basePrice, 1, 'WHITESPACE', 2, 'POINT').replaceAll('0$', '')} + ' ֏'">
                </td>
                <td style="text-align: center;"
                    th:text="${(discount != null and discount.doubleValue() > 0) ? (discount.doubleValue() % 1 == 0 ? #numbers.formatInteger(discount, 1) : #numbers.formatDecimal(discount, 1, 1, 'POINT').replaceAll('0$', '')) + '%' : '-'}">
                </td>
            </th:block>

            <!-- Цена и Сумма с вашим форматированием -->
            <td style="text-align: right;"
                th:text="${finalPrice.doubleValue() % 1 == 0 ? #numbers.formatDecimal(finalPrice, 1, 'WHITESPACE', 0, 'POINT') : #numbers.formatDecimal(finalPrice, 1, 'WHITESPACE', 2, 'POINT').replaceAll('0$', '')} + ' ֏'">
            </td>
            <td style="text-align: right;"
                th:text="${rowTotal % 1 == 0 ? #numbers.formatDecimal(rowTotal, 1, 'WHITESPACE', 0, 'POINT') : #numbers.formatDecimal(rowTotal, 1, 'WHITESPACE', 2, 'POINT').replaceAll('0$', '')} + ' ֏'">
            </td>
        </tr>
        </tbody>
    </table>

    <div class="total-block">
        ИТОГО К ОПЛАТЕ:
        <span th:with="total=${op.totalAmount != null ? op.totalAmount.doubleValue() : 0}"
              th:text="${total % 1 == 0 ? #numbers.formatDecimal(total, 1, 'WHITESPACE', 0, 'POINT') : #numbers.formatDecimal(total, 1, 'WHITESPACE', 2, 'POINT').replaceAll('0$', '')} + ' ֏'">
        </span>
    </div>

    <div th:if="${op.comment != null && !#strings.isEmpty(op.comment)}" style="margin-top: 15px; font-style: italic; font-size: 10px;">
        Примечание: <span th:text="${op.comment}"></span>
    </div>

    <div class="footer-sig">
        <div class="sig-line">Отпустил (Подпись)</div>
        <div class="sig-line">Получил (Подпись / Печать)</div>
    </div>
</div>

</body>
</html>
